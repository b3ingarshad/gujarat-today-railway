{% extends 'base.html' %}

{% block title %}
{{ category_name }}
{% endblock %}

{% block start %}

<section class="banner banner__default bg-grey-light-three">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-12">
                <div class="post-title-wrapper">
                    <h2 class="m-b-xs-0 axil-post-title hover-line">{{ category_name }}</h2>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Category-wise news section -->
<section class="section-gap section-gap-top__with-text trending-stories">
    <div class="container">
        <div class="row" id="dynamicPageOfCategory">
            <!-- Fetched news items will be inserted here dynamically -->
        </div>
    </div>
    <!-- Pagination controls -->
    {% if page_obj.paginator.count > 12 %} <!-- Only show pagination if more than 10 items -->
    <div id="paginationControls" class="text-center mt-4">
        <button id="prevPage" class="btn btn-primary" style="display: none;">&laquo; Previous</button>
        <span id="pageNumbers" class="mx-2"></span>
        <button id="nextPage" class="btn btn-primary" style="display: none;">Next &raquo;</button>
    </div>
{% endif %}
</section>

<!-- Script to load news dynamically based on the selected category -->
<script>
    function renderPagination(currentPage, totalPages) {
        const pageNumbersContainer = document.getElementById('pageNumbers');
        pageNumbersContainer.innerHTML = '';  // Clear previous pagination buttons
    
        const createPageButton = (pageNum, isActive = false) => {
            const pageButton = document.createElement('button');
            pageButton.textContent = pageNum;
            pageButton.className = `btn btn-secondary mx-1${isActive ? ' active' : ''}`;
            pageButton.disabled = isActive;
    
            // Add click event to load the respective page
            if (!isActive) {
                pageButton.addEventListener('click', function () {
                    window.location.href = `?page=${pageNum}&category=${category_name}`;
                });
            }
    
            return pageButton;
        };
    
        const addEllipsis = () => {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.className = 'mx-2';
            pageNumbersContainer.appendChild(ellipsis);
        };
    
        // Always show the first page
        pageNumbersContainer.appendChild(createPageButton(1, currentPage === 1));
    
        // Show ellipsis if currentPage is greater than 3
        if (currentPage > 3) {
            addEllipsis();
        }
    
        // Define the range of visible pages (dynamic based on the current page)
        const startPage = Math.max(2, currentPage - 1);
        const endPage = Math.min(totalPages - 1, currentPage + 1);
    
        // Show the current page and the neighboring pages
        for (let i = startPage; i <= endPage; i++) {
            pageNumbersContainer.appendChild(createPageButton(i, i === currentPage));
        }
    
        // Show ellipsis if currentPage is less than totalPages - 2
        if (currentPage < totalPages - 2) {
            addEllipsis();
        }
    
        // Always show the last page
        if (totalPages > 1) {
            pageNumbersContainer.appendChild(createPageButton(totalPages, currentPage === totalPages));
        }
    }
    document.addEventListener('DOMContentLoaded', function () {
        const topDynamicPageOfCategory = document.getElementById('dynamicPageOfCategory');
//        const newsList = JSON.parse('{{ news_list_json|safe }}');
        const currentPage = parseInt('{{ page_obj.number }}');
        const totalPages = parseInt('{{ page_obj.paginator.num_pages }}');
        const category_name = "{{ category_name|escapejs }}";
        const newsList = JSON.parse('{{ news_list_json|escapejs }}');       
        renderPagination(currentPage, totalPages);
        // Function to render news articles
        function renderNews(newsList) {
            topDynamicPageOfCategory.innerHTML = '';  // Clear the container

            newsList.forEach(article => {
                const articleDate = new Date(article.date);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                const formattedDate = articleDate.toLocaleDateString('en-US', options);

                const articleHTML = `
                    <div class="col-lg-4">
                        <div class="axil-img-container m-b-xs-30">
                            <a href="/news/${article.id}" class="d-block">
                                <img src="${article.image}" alt="${article.title}" class="w-100">
                                <div class="grad-overlay"></div>
                            </a>
                            <div class="media post-block position-absolute">
                                <div class="media-body">
                                    <div class="post-cat-group m-b-xs-10">
                                        <a href="/${article.category_url}" class="post-cat cat-btn" style="background-color: ${article.category_color};">
                                            ${article.category}
                                        </a>
                                    </div>
                                    <div class="axil-media-bottom">
                                        <h3 class="axil-post-title hover-line hover-line">
                                            <a href="/news/${article.id}">${article.title}</a>
                                        </h3>
                                        <div class="post-metas">
                                            <ul class="list-inline">
                                                <li>By <a href="#" class="post-author">${article.author}</a></li>
                                                <li><i class="dot">.</i> ${formattedDate}</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                topDynamicPageOfCategory.innerHTML += articleHTML;
            });
        }

        // Render the news on page load
        renderNews(newsList);

        // Show/hide pagination controls based on current page
        document.getElementById('prevPage').style.display = currentPage > 1 ? 'inline-block' : 'none';
        document.getElementById('nextPage').style.display = currentPage < totalPages ? 'inline-block' : 'none';

        // Generate pagination numbers
        const pageNumbersContainer = document.getElementById('pageNumbers');
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.className = 'btn btn-secondary mx-1';
            pageButton.disabled = (i === currentPage);  // Disable current page button

            // Add click event to load the respective page
            pageButton.addEventListener('click', function () {
                window.location.href = `?page=${i}&category=${category_name}`;
            });

            pageNumbersContainer.appendChild(pageButton);
        }

        // Pagination button event listeners
        document.getElementById('prevPage').addEventListener('click', function () {
            window.location.href = `?page=${currentPage - 1}&category=${category_name}`;
        });

        document.getElementById('nextPage').addEventListener('click', function () {
            window.location.href = `?page=${currentPage + 1}&category=${category_name}`;
        });
    });
</script>

{% endblock %}
